<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/validation/formValidation/formValidation.js | validation-service</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A validation service to run form inputs against validators."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="validation-service"><meta property="twitter:description" content="A validation service to run form inputs against validators."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#cache">cache</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cache/cache.service.js~Cache.html">Cache</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#validation">validation</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/validation.service.dom.js~ValidationServiceDom.html">ValidationServiceDom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/validation.service.js~ValidationService.html">ValidationService</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#validation-formvalidation">validation/formValidation</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/formValidation/behaviour.js~Behaviour.html">Behaviour</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/formValidation/cache.js~Cache.html">Cache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/formValidation/feedbackDisplay.js~FeedbackDisplay.html">FeedbackDisplay</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/formValidation/formValidation.js~FormValidation.html">FormValidation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/formValidation/resolver.js~Resolver.html">Resolver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-condition">condition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eventDispatch">eventDispatch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getValidationFields">getValidationFields</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#validation-formvalidation-validators">validation/formValidation/validators</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-email">email</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-required">required</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/validation/formValidation/formValidation.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {ValidationServiceDom} from &apos;../validation.service.dom&apos;;

import {Cache} from &apos;./cache&apos;;

import {Resolver} from &apos;./resolver&apos;;

import {FeedbackDisplay} from &apos;./feedbackDisplay&apos;;

import condition from &apos;./condition&apos;;
import {Behaviour} from &apos;./behaviour&apos;;

import defaultValidatorRequired from &apos;./validators/required&apos;;
import defaultValidatorEmail from &apos;./validators/email&apos;;

import getValidationFields from &apos;./getValidationFields&apos;;

/**
 * This Class offers form validation via html driven setup combined with customized or default validators
 *
 * @example
 &lt;form id=&quot;form&quot;&gt;

 &lt;input name=&quot;name&quot; id=&quot;name&quot;
 data-validation=&apos;{
     &quot;validators&quot;: {
     &quot;required&quot;: { &quot;message&quot;: &quot;Required \&quot;name\&quot; not set&quot; } },
     &quot;feedbackDisplay&quot;: {
        &quot;messageLocation&quot;: [ { &quot;minWidth&quot;: 0, &quot;insertTargetSelector&quot;: &quot;[for=\&quot;name\&quot;]&quot; } ]
     }
    }&apos;
 &gt;

 &lt;button id=&quot;submit-btn&quot; type=&quot;submit&quot;&gt;Validate Form&lt;/button&gt;
 &lt;/form&gt;

 &lt;script type=&quot;text/javascript&quot;&gt;

 var options = {
        formId: &apos;form&apos;,
        caching: false
    }

 var validationService = new FormValidation( options );

 var form = document.getElementById( &apos;form&apos; );

 form.addEventListener( &apos;submit&apos;, function( event ) {
    event.preventDefault();

    validationService.validateForm().then( function( result ) {
        console.log( &apos;-----&gt;validateForm success&apos;, result );
        form.submit();
    } ).catch( function( result ) {
        console.log( &apos;-----&gt;validateForm fail&apos;, result );
    } );

} );

 &lt;/script&gt;
 */
export class FormValidation {

    /**
     * @param {Object} options - The options to set. You have to set the form id for a minimal configuration setup.
     * @param {String} options.formId (default=null} - Id of the form.
     * @param {Boolean} [options.caching=true] - Enabling/disabling caching of form validation.
     * @param {Boolean} [options.stopValidationOnFirstFail=true] -
     * Stops further validation of field if one validator fails.
     * @param {Function} [options.condition] - (default={@link condition})
     * This condition function provides a condition for each field validation.
     * @param {Class} [options.Behaviour] - (default={@link Behaviour})
     * This Behaviour Class is setting up the validation behaviour for each field.
     * @param {Object} [options.validators] - (default={@link defaultValidatorRequired}, {@link defaultValidatorEmail})
     * @param {Object} [options.feedbackDisplayOptions] - (default={@link FeedbackDisplay.getOptions})
     */
    constructor( options ) {

        /**
         *
         * @type {Object} - merged options
         */
        this.options = this.getMergedOptions( options );

        /**
         * {@link FeedbackDisplay}
         * @type {Class}
         */
        this.feedbackDisplay = new FeedbackDisplay( options.feedbackDisplayOptions );

        /**
         * {@link Cache}
         * cache set a to this context to make them public
         * @type {Class}
         */
        this.cache = new Cache( this.options.validationAttr );

        /**
         * @type {Array} - Field dom references
         */
        var fields = this.getValidationFields();

        /**
         * {@link getValidationConfig}
         * @type {Object}
         */
        this.config = this.getValidationConfig( fields );

        /**
         * {@link getValidationFieldConfig}
         * @type {Object}
         */
        this.configFields = this.getValidationFieldConfig( fields );
    }

    /**
     *
     * @type {Class} Resolver
     */
    setResolver() {
        this.resolver = new Resolver(
            this.configFields,
            this.options.validators,
            this.feedbackDisplay );
    }

    /**
     * Initializes the validation service
     * and field behaviour.
     */
    setValidationAndBehaviour() {
        /**
         * {@link ValidationServiceDom}
         * @type {Class}
         */
        this.validation = new ValidationServiceDom(
            this.config,
            this.resolver.resolver(),
            this.options.caching ? this.cache.getValidationCache() : this.cache.getValidationOffCache(),
            this.options.stopValidationOnFirstFail );

        /**
         *
         * @type {Object} behaviour {@link Behaviour}
         */
        try {
            this.behaviour = new this.options.Behaviour(
                this.options.formId,
                this.options.validationAttr,
                this.options.condition,
                this.configFields,
                this.validation );
            this.behaviour.behaviour();

        } catch ( error ) {
            // console.log( &apos;options.Behaviour must be a class/prototype to be instanciated of this.behaviour&apos; );
            throw new Error( &apos;options.Behaviour must be a class/prototype to be instanciated of this.behaviour&apos; );
        }

    }

    /**
     * Does the required setup.
     * Set in extra part - why?
     * This allows to manipulate several objects for customization
     */
    init() {
        this.setResolver();
        this.setValidationAndBehaviour();
    }

    /**
     *
     * @return {Object}
     * @property {Boolean} caching : true
     * @property {String} formID : null
     * @property {String} validationAttr: &apos;data-validation&apos;
     * @property {Boolean} stopValidationOnFirstFail : true
     * @property {Function} condition {@link condition}
     * @property {Class} Behaviour  {@link behaviour}
     * @property {Object} validators
     * @property {Promise} validators.required {@link defaultValidatorRequired}
     * @property {Promise} validators.email {@link defaultValidatorEmail}
     * */
    getDefaultOptions() {
        return {
            caching: true,
            formId: null,
            validationAttr: &apos;data-validation&apos;,
            stopValidationOnFirstFail: true,
            condition: condition,
            Behaviour: Behaviour,

            validators: {
                required: defaultValidatorRequired,
                email: defaultValidatorEmail
            }
        };
    }

    /**
     * Merges default options given options
     * @param {Object} options
     * @returns {Object}
     */
    getMergedOptions( options ) {
        if ( typeof options === &apos;undefined&apos; || typeof options !== &apos;object&apos; ) {
            throw new TypeError( &apos;Options must be an object.&apos; );
        }

        if ( typeof options === &apos;object&apos; ) {
            if ( typeof options.formId !== &apos;string&apos; ) {
                throw new TypeError( &apos;Options formID must be String.&apos; );
            }
        }

        /**
         * The options merged by default options and param options.
         * @type {Object}
         */
        var opt = Object.assign( this.getDefaultOptions(), options );
        /**
         * Merging via assign is not working proper on subobjects.
         * So we have to merge separately.
         * @type {Object}
         */
        opt.validators = Object.assign( this.getDefaultOptions().validators, options.validators );
        return opt;
    }

    /**
     * @link {getValidationFields}
     * @returns {Array}
     */
    getValidationFields() {
        return getValidationFields(
            this.options.formId,
            this.options.validationAttr,
            this.options.condition );
    }

    getFieldData( field ) {
        var objData = field.getAttribute( this.options.validationAttr );
        try {
            objData = JSON.parse( objData );
        } catch ( error ) {
            console.log( &apos;Error while trying to parse objData:&apos; + objData );
            console.log( &apos;Error:&apos; + error );
        }
        return objData;
    }

    /**
     * Fills up validation config of fields via data attributes of fields and Id of each field.
     * {@link ValidationService}
     *
     * @example
     * &lt;input name=&quot;name&quot; id=&quot;nameId&quot;
     *    data-validation=&apos;{
     *           &quot;validators&quot;: {&quot;required&quot;: { &quot;message&quot;: &quot;This field is required&quot; }
     *           }&apos;&gt;
     *
     * {
     *     nameId: {
     *         required: { message: &apos;This field is required&apos; }
     *     }
     * }
     * @param {Array} fields - Array of field references to dom
     * @returns {Object}
     */
    getValidationConfig( fields ) {
        var configService = {};

        fields.forEach( function( field ) {
            var objData = this.getFieldData( field );

            var validators = {};
            if ( typeof objData.validators !== &apos;object&apos; ) {
                throw new TypeError( &apos;validators must be of type object&apos; );
            }
            Object.keys( objData.validators ).forEach( function( validatorName ) {
                var obj = {
                    message: objData.validators[ validatorName ].message
                };
                validators[ validatorName ] = obj;
            } );

            if ( Object.keys( objData.validators ).length &lt; 1 ) {
                throw new Error( &apos;no validators specified&apos; );
            }

            configService[ field.id ] = validators;
        }.bind( this ) );
        return configService;
    }

    /**
     * Fills up the validation data values
     * (Id of fields with it&apos;s value).
     * This values are used to validate.
     * {@link ValidationService.validate},
     * ({@link ValidationServiceDom.setValueByField},
     * {@link ValidationService.getValue} )
     */
    setValues() {
        var fieldIdentifiers = Object.keys( this.config );
        fieldIdentifiers.forEach( function( identifier ) {
            var el = document.getElementById( identifier );
            this.validation.setValueByField( el );
        }.bind( this ) );
    }

    /**
     * This function should be called
     * if any input fields have been added or deleted.
     * or before a validation of the entire form starts (Its called by {@link validateForm} )
     */
    updateConfigAndValuesAndBehaviour() {
        /**
         * @type {Array} - Field dom references
         */
        var fields = this.getValidationFields();
        this.config = this.getValidationConfig( fields );
        this.configFields = this.getValidationFieldConfig( fields );
        this.validation.setConfig( this.config );
        this.setValues();
        this.setResolver();
        this.validation.setResolver( this.resolver.resolver() );
        this.behaviour.updateConfigFieldsAndValidation( this.configFields, this.validation );
        this.behaviour.behaviour();
    }

    /**
     * This function is validating the entire form.
     * @returns {Promise}
     */
    validateForm() {
        return this.validation.validateForm( this.options.formId );
    }

    /**
     * The Default field config for each field.
     * @return {Object} This data is used in {@link getValidationFieldConfig}
     * @property {null} validators : null
     * @property {Object} feedbackDisplay {@link FeedbackDisplay.getDefaultFieldOptions}
     * @property {Boolean} caching : false
     * @property {Boolean} setEventOnValidation : false
     * @property {null} sendToValidatorDataGroupSel : null {@link Resolver}
     * @property {null} behaviourGroupSel : null - used in {@link Behaviour}
     */
    getDefaultValidationFieldConfig() {
        return {
            validators: null,
            feedbackDisplay: FeedbackDisplay.getDefaultFieldOptions(),
            caching: true,
            setEventOnValidation: false,
            sendToValidatorDataGroupSel: null,
            behaviourGroupSel: null
        };
    }

    /**
     * Merges the default field config {@link getDefaultValidationFieldConfig}
     * for each field with the HTML given config.
     * @param {Array} fields - Array of field references to dom
     * @return {Object}
     * @property {null|Object} validators : null|Object
     * @property {Object} feedbackDisplay
     * @property {Boolean} caching : true|false
     * @property {Boolean} setEventOnValidation : false|true
     * @property {String} behaviourGroupSel : null|*css selector*
     *
     */
    getValidationFieldConfig( fields ) {
        var config = {};
        var configFields = {};
        fields.forEach( function( field ) {
            var objData = this.getFieldData( field );
            var objDataField = this.getDefaultValidationFieldConfig();
            objDataField.validators = objData.validators;
            Object.keys( objData ).forEach( function( key ) {
                if ( key !== &apos;validators&apos; ) {
                    if ( key === &apos;feedbackDisplay&apos; ) {
                        Object.keys( objData.feedbackDisplay ).forEach( function( key ) {
                            if ( key === &apos;messageLocation&apos; ) {
                                FeedbackDisplay.checkMessageLocationDataFormat( objData.feedbackDisplay[ key ] );
                            }
                            objDataField.feedbackDisplay[ key ] = objData.feedbackDisplay[ key ];
                        }.bind( this ) );
                    } else {
                        objDataField[ key ] = objData[ key ];
                    }
                }
            }.bind( this ) );

            configFields[ field.id ] = objDataField;
        }.bind( this ) );
        config.fields = configFields;
        return config.fields;
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
