<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/validation/validation.service.js | validation-service</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A validation service to run form inputs against validators."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="validation-service"><meta property="twitter:description" content="A validation service to run form inputs against validators."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#cache">cache</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cache/cache.service.js~Cache.html">Cache</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#validation">validation</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/validation.service.dom.js~ValidationServiceDom.html">ValidationServiceDom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/validation.service.js~ValidationService.html">ValidationService</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#validation-formvalidation">validation/formValidation</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/formValidation/behaviour.js~Behaviour.html">Behaviour</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/formValidation/cache.js~Cache.html">Cache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/formValidation/feedbackDisplay.js~FeedbackDisplay.html">FeedbackDisplay</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/formValidation/formValidation.js~FormValidation.html">FormValidation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validation/formValidation/resolver.js~Resolver.html">Resolver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-condition">condition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eventDispatch">eventDispatch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getValidationFields">getValidationFields</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#validation-formvalidation-validators">validation/formValidation/validators</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-email">email</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-required">required</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/validation/validation.service.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * # The validator service
 *
 * This service dispatches several validations to the right validators. It accepts a config for each field
 * configuring the validators and a validationResolver. A config can look like this:
 *
 * ```
 * {
 *     fieldA: {
 *         required: { message: &apos;This field is required&apos; },
 *         email: { message: &apos;This field must contain a valid email address&apos; }
 *         ajax: { endpoint: &apos;http://localhost/validation&apos; }
 *     },
 *     fieldB: {
 *         required: { message: &apos;Field B is required&apos; }
 *     }
 * }
 * ```
 *
 * The validation resolver must implement a getValidator method accepting the validator name as an argument
 * validator is passed.
 *
 * ## Validators
 *
 * A validator must implement a certain interface. This interface is not checked, so be sure to implement it
 * the right way.
 *
 * There are four parameters passed to the validator:
 *
 * 1. The value which should be validate
 * 2. The config for the validator coming straight from the service config
 * 3. The validator service itself to eventually do validation on dependencies
 * 4. The fieldname to handle field propertys in validator (e.g. visibility)
 *
 * The validator **must** return a promise which is resolved when the validation is valid and rejects
 * when the validation fails. The results must be passed to the resolve/reject function as an object looking
 * like this:
 *
 * ```
 * {
 *     isValid: false,
 *     message: &apos;This is a validation message which can come via config&apos;
 * }
 * ```
 *
 * When the validation in a validator is successful the the `isValid` property should be true and there is
 * no message. For an invalid validation the message is helpful for the user.
 */
export class ValidationService {

    /**
     * @param {Object} config
     * @param {Object} validationResolver
     * @param {Object} cache
     * @param {Boolean} stopValidationOnFirstFail
     * @throws {TypeError}
     * @constructor
     */
    constructor( config, validationResolver, cache, stopValidationOnFirstFail ) {
        if ( config === undefined || typeof config !== &apos;object&apos; || Array.isArray( config ) ) {
            throw new TypeError( &apos;Config must be an object&apos; );
        }

        if ( typeof validationResolver.getValidator !== &apos;function&apos; ) {
            throw new TypeError( &apos;The validation resolver must implement the getValidator function&apos; );
        }

        if ( typeof cache.getValue !== &apos;function&apos; || typeof cache.setValue !== &apos;function&apos; ) {
            throw new TypeError( &apos;The cache must be implement the cache interface&apos; );
        }

        /**
         *
         * @type {Boolean}
         */
        this.stopValidationOnFirstFail = false;
        if ( typeof stopValidationOnFirstFail !== &apos;undefined&apos; &amp;&amp; typeof stopValidationOnFirstFail !== &apos;boolean&apos; ) {
            throw new TypeError( &apos;The stopValidationOnFirstFail param must be of type boolean if set.&apos; );
        } else if ( typeof stopValidationOnFirstFail !== &apos;undefined&apos; ) {
            this.stopValidationOnFirstFail = stopValidationOnFirstFail ;
        }

        /**
         *
         * @type {Object}
         */
        this.validationResolver = validationResolver;
        /**
         *
         * @type {Object}
         */
        this.config = config;
        /**
         *
         * @type {Object}
         */
        this.data = {};
        /**
         *
         * @type {Object}
         */
        this.cache = cache;
    }

    /**
     * Set config
     *
     * @param {Object} config
     */
    setConfig( config ) {
        this.config = config;
    }

    /**
     * Set resolver
     *
     * @param {Object} validationResolver
     */
    setResolver( validationResolver ) {
        this.validationResolver = validationResolver;
    }

    /**
     * Set all values
     * @example
     * validationService.setValues( {
            name: &apos;Elvis&apos;,
            nickname: &apos;The Pelvis&apos;
        } );
     *
     * @param {Object} data
     */
    setValues( data ) {
        this.data = data;
    }

    /**
     * Set one value
     * @example
     * validationService.setValue( &apos;name&apos;, &apos;Elvis&apos; );
     *
     * @param {String} name
     * @param {String|Array} value
     */
    setValue( name, value ) {
        this.data[ name ] = value;
    }

    /**
     * Returns all values
     *
     * @return {Object}
     */
    getValues() {
        return this.data;
    }

    /**
     * Returns one specific value
     *
     * @param {String} name
     * @return {String/Array}
     */
    getValue( name ) {
        return this.data[ name ];
    }

    /**
     * Returns all configured fields
     *
     * @return {Array}
     */
    getFields() {
        return Object.keys( this.config );
    }

    /**
     * Validate one field
     *
     * @param {String} field
     * @param {String} formId
     * @return {Promise}
     */
    validate( field, formId ) {
        return new Promise( function( resolve, reject ) {
            var validators = this.config[ field ];

            if ( validators === undefined ) {
                resolve( { isValid: true } );
            }

            var validatorNames = Object.keys( validators );

            var resolvedCount = 0;
            var hasError = false;

            var validationResults = {};

            var handleValidationResult = function( validationResult, validatorName ) {
                resolvedCount++;

                validationResults[ validatorName ] = validationResult;

                if ( resolvedCount === validatorNames.length &amp;&amp; hasError === false ) {
                    resolve( {
                        isValid: true,
                        results: validationResults
                    } );
                } else if ( resolvedCount === validatorNames.length ||
                    ( this.stopValidationOnFirstFail &amp;&amp; hasError ) ) {
                    reject( {
                        isValid: false,
                        results: validationResults
                    } );
                } else {
                    if ( ( !this.stopValidationOnFirstFail || hasError === false ) ) {
                        handleValidation( validatorNames[ resolvedCount ] );
                    }
                }
            }.bind( this );

            var value = this.getValue( field );

            var cacheKey = formId + &apos;.&apos; + field; // TODO: discuss if formId is needed

            var isCached = this.cache.isCached( cacheKey );

            var cached = isCached ? this.cache.getValue( cacheKey ) :
                {
                    value: value,
                    results: {}
                };

            var handleValidation = function( validatorName ) {

                if ( isCached &amp;&amp; cached.value === value &amp;&amp; cached.results[ validatorName ] !== undefined ) {
                    if ( cached.results[ validatorName ].isValid === false ) {
                        hasError = true;
                    }
                    handleValidationResult( cached.results[ validatorName ], validatorName );
                    return;
                }

                cached.value = value;

                this.validationResolver.getValidator( validatorName ).then( function( validator ) {

                    return validator(
                        value,
                        validators[ validatorName ],
                        this,
                        field
                    ).then( function( validationResult ) {
                        cached.results[ validatorName ] = validationResult;
                        this.cache.setValue( cacheKey, cached );

                        handleValidationResult( validationResult, validatorName );

                    }.bind( this ) ).catch( function( validationResult ) {
                        cached.results[ validatorName ] = validationResult;
                        this.cache.setValue( cacheKey, cached );

                        hasError = true;
                        handleValidationResult( validationResult, validatorName );

                    }.bind( this ) );

                }.bind( this ) );


            }.bind( this );

            handleValidation( validatorNames[ resolvedCount ] );

        }.bind( this ) );
    }

    /**
     * Validate the whole form
     *
     * @param {String} formId
     * @return {Promise}
     */
    validateForm( formId ) {
        formId = formId || &apos;&apos;;
        return new Promise( function( resolve, reject ) {
            var fieldNames = this.getFields();

            var resolvedCount = 0;
            var hasError = false;

            var validationResults = {};

            var handleValidationResult = function( validationResult, field ) {
                resolvedCount++;
                validationResults[ field ] = validationResult;

                if ( resolvedCount === fieldNames.length &amp;&amp; hasError === false ) {
                    resolve( {
                        isValid: true,
                        results: validationResults
                    } );
                } else if ( resolvedCount === fieldNames.length ) {
                    reject( {
                        isValid: false,
                        results: validationResults
                    } );
                }
            }.bind( this );

            fieldNames.forEach( function( fieldName ) {
                this.validate( fieldName, formId ).then( function( validationResult ) {
                    handleValidationResult( validationResult, fieldName );
                } ).catch( function( validationResult ) {
                    hasError = true;
                    handleValidationResult( validationResult, fieldName );
                } );
            }.bind( this ) );
        }.bind( this ) );
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
